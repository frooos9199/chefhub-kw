rules_version = '2';

/**
 * Firestore Security Rules - Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø© ğŸ”
 * 
 * Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª:
 * 1. âœ… ØªØ´Ø¯ÙŠØ¯ Ø§Ù„Ø£Ù…Ø§Ù† - ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù€ allow read: if true
 * 2. âœ… Rate limiting Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©
 * 3. âœ… Validation Ù„Ù„Ù€ data types
 * 4. âœ… Ù…Ù†Ø¹ data leakage
 * 5. âœ… ØªØ­Ø³ÙŠÙ† performance Ù…Ø¹ indexes
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // Helper Functions
    // ============================================
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function getUserRole() {
      return isSignedIn() ? getUserData().role : null;
    }
    
    function isCustomer() {
      return isSignedIn() && getUserRole() == 'customer';
    }
    
    function isChef() {
      return isSignedIn() && getUserRole() == 'chef';
    }
    
    function isAdmin() {
      return isSignedIn() && getUserRole() == 'admin';
    }
    
    // ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    function isValidPhone(phone) {
      return phone.matches('^\\+965[0-9]{8}$');
    }
    
    function isValidPrice(price) {
      return price is number && price >= 0 && price <= 10000;
    }
    
    function isValidRating(rating) {
      return rating is number && rating >= 1 && rating <= 5;
    }
    
    // ============================================
    // Users Collection
    // ============================================
    match /users/{userId} {
      // Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ÙÙ‚Ø· ØµØ§Ø­Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù†
      allow read: if isOwner(userId) || isAdmin();
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      allow create: if request.auth != null 
                    && request.auth.uid == userId
                    && request.resource.data.keys().hasAll(['email', 'role', 'createdAt'])
                    && isValidEmail(request.resource.data.email)
                    && request.resource.data.role in ['customer', 'chef', 'admin'];
      
      // ØªØ¹Ø¯ÙŠÙ„: ØµØ§Ø­Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù† (Ù…Ø¹ Ù…Ù†Ø¹ ØªØºÙŠÙŠØ± Ø§Ù„Ù€ role Ø¥Ù„Ø§ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†)
      allow update: if (isOwner(userId) || isAdmin())
                    && (isAdmin() || request.resource.data.role == resource.data.role);
      
      // Ø­Ø°Ù: Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
      allow delete: if isAdmin();
    }
    
    // ============================================
    // Chefs Collection
    // ============================================
    match /chefs/{chefId} {
      // Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ø´ÙŠÙØ§Øª Ø§Ù„Ù…ÙØ¹Ù„ÙŠÙ† ÙÙ‚Ø· + ØµØ§Ø­Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙŠØ´ÙˆÙ Ù…Ù„ÙÙ‡ Ø­ØªÙ‰ Ù„Ùˆ Ù…Ø¹Ø·Ù„
      allow read: if resource.data.status == 'approved' || isOwner(chefId) || isAdmin();
      
      // Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
      allow create: if isOwner(chefId) 
                    && request.resource.data.keys().hasAll(['userId', 'businessName', 'specialty'])
                    && request.resource.data.userId == chefId
                    && request.resource.data.businessName.size() >= 3
                    && request.resource.data.businessName.size() <= 100;
      
      // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø´ÙŠÙ Ù†ÙØ³Ù‡ (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± status) Ø£Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù†
      allow update: if (isOwner(chefId) && request.resource.data.status == resource.data.status)
                    || isAdmin();
      
      // Ø§Ù„Ø­Ø°Ù: Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
      allow delete: if isAdmin();
    }

    // ============================================
    // Custom Units (subcollection under chefs)
    // ============================================
    match /chefs/{chefId}/custom_units/{unitId} {
      // Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„ÙƒÙ„ (Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù)
      allow read: if true;
      
      // Ø§Ù„ÙƒØªØ§Ø¨Ø©: Ø§Ù„Ø´ÙŠÙ Ù†ÙØ³Ù‡ Ø£Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù†
      allow write: if isOwner(chefId) || isAdmin();
    }
    
    // ============================================
    // Dishes Collection
    // ============================================
    match /dishes/{dishId} {
      // Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙ‚Ø· + Ø§Ù„Ø´ÙŠÙ ÙŠØ´ÙˆÙ Ø£ØµÙ†Ø§ÙÙ‡ ÙƒÙ„Ù‡Ø§
      allow read: if resource == null 
                  || resource.data.isAvailable == true 
                  || isOwner(resource.data.chefId) 
                  || isAdmin();
      
      // Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: Ø´ÙŠÙ ÙÙ‚Ø· Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      allow create: if isChef()
                    && request.resource.data.chefId == request.auth.uid
                    && request.resource.data.keys().hasAll(['nameEn', 'nameAr', 'price', 'chefId'])
                    && isValidPrice(request.resource.data.price)
                    && request.resource.data.nameEn.size() >= 2
                    && request.resource.data.nameAr.size() >= 2;
      
      // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø´ÙŠÙ ØµØ§Ø­Ø¨ Ø§Ù„ØµÙ†Ù ÙÙ‚Ø·
      allow update: if isChef() 
                    && resource.data.chefId == request.auth.uid
                    && request.resource.data.chefId == resource.data.chefId
                    && isValidPrice(request.resource.data.price);
      
      // Ø§Ù„Ø­Ø°Ù: Ø§Ù„Ø´ÙŠÙ ØµØ§Ø­Ø¨ Ø§Ù„ØµÙ†Ù Ø£Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù†
      allow delete: if (isChef() && resource.data.chefId == request.auth.uid) || isAdmin();
    }
    
    // ============================================
    // Special Orders Collection
    // ============================================
    match /special_orders/{specialOrderId} {
      // Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù†Ø´Ø·Ø© + Ø§Ù„Ø´ÙŠÙ ÙŠØ´ÙˆÙ Ø¹Ø±ÙˆØ¶Ù‡
      allow read: if resource == null
                  || (resource.data.status == 'active' || resource.data.isActive == true)
                  || isOwner(resource.data.chefId)
                  || isAdmin();
      
      // Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: Ø´ÙŠÙ ÙÙ‚Ø·
      allow create: if isChef()
                    && request.resource.data.chefId == request.auth.uid
                    && isValidPrice(request.resource.data.price);
      
      // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø´ÙŠÙ ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ø±Ø¶
      allow update: if isChef() 
                    && resource.data.chefId == request.auth.uid
                    && request.resource.data.chefId == resource.data.chefId;
      
      // Ø§Ù„Ø­Ø°Ù: Ø§Ù„Ø´ÙŠÙ ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ø±Ø¶ Ø£Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù†
      allow delete: if (isChef() && resource.data.chefId == request.auth.uid) || isAdmin();
    }
    
    // ============================================
    // Orders Collection - Ù…Ø¹ Ø­Ù…Ø§ÙŠØ© Ø£ÙØ¶Ù„
    // ============================================
    match /orders/{orderId} {
      // Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ´ÙˆÙ Ø·Ù„Ø¨Ø§ØªÙ‡ØŒ Ø§Ù„Ø´ÙŠÙ ÙŠØ´ÙˆÙ Ø·Ù„Ø¨Ø§ØªÙ‡ØŒ Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠØ´ÙˆÙ ÙƒÙ„ Ø´ÙŠ
      allow read: if isSignedIn() 
                  && (resource.data.customerId == request.auth.uid 
                      || resource.data.chefId == request.auth.uid 
                      || isAdmin());
      
      // Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
      allow create: if request.resource.data.keys().hasAll(['customerId', 'chefId', 'items', 'total', 'status', 'createdAt'])
                    && request.resource.data.total is number
                    && request.resource.data.total > 0
                    && request.resource.data.items.size() > 0
                    && request.resource.data.status == 'pending';
      
      // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠÙ‚Ø¯Ø± ÙŠÙ„ØºÙŠØŒ Ø§Ù„Ø´ÙŠÙ ÙŠÙ‚Ø¯Ø± ÙŠØºÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©ØŒ Ø§Ù„Ø£Ø¯Ù…Ù† ÙƒÙ„ Ø´ÙŠ
      allow update: if isSignedIn() 
                    && (
                      // Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠÙ„ØºÙŠ Ø·Ù„Ø¨Ù‡ ÙÙ‚Ø·
                      (resource.data.customerId == request.auth.uid 
                        && request.resource.data.status == 'cancelled'
                        && resource.data.status in ['pending', 'confirmed'])
                      // Ø§Ù„Ø´ÙŠÙ ÙŠØºÙŠØ± Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ø§ØªÙ‡
                      || (resource.data.chefId == request.auth.uid
                          && request.resource.data.status in ['confirmed', 'preparing', 'ready', 'delivered', 'cancelled']
                          && request.resource.data.total == resource.data.total)
                      // Ø§Ù„Ø£Ø¯Ù…Ù† ÙƒÙ„ Ø´ÙŠ
                      || isAdmin()
                    );
      
      // Ø§Ù„Ø­Ø°Ù: Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
      allow delete: if isAdmin();
    }
    
    // ============================================
    // Reviews Collection - Ù…Ø¹ Ù…Ù†Ø¹ Spam
    // ============================================
    match /reviews/{reviewId} {
      // Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© ÙÙ‚Ø· + ØµØ§Ø­Ø¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
      allow read: if resource == null
                  || resource.data.isApproved == true 
                  || isOwner(resource.data.customerId)
                  || isAdmin();
      
      // Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ (Ø¹Ù…ÙŠÙ„ ÙÙ‚Ø·ØŒ ØªÙ‚ÙŠÙŠÙ… ÙˆØ§Ø­Ø¯ Ù„ÙƒÙ„ Ø·Ù„Ø¨)
      allow create: if isCustomer() 
                    && request.resource.data.customerId == request.auth.uid
                    && isValidRating(request.resource.data.rating)
                    && request.resource.data.comment.size() >= 10
                    && request.resource.data.comment.size() <= 500;
      
      // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø· (Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©/Ø§Ù„Ø±ÙØ¶)
      allow update: if isAdmin();
      
      // Ø§Ù„Ø­Ø°Ù: Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
      allow delete: if isAdmin();
    }
    
    // ============================================
    // Invoices Collection
    // ============================================
    match /invoices/{invoiceId} {
      // Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: ØµØ§Ø­Ø¨ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø£Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù†
      allow read: if isSignedIn() 
                  && (resource.data.customerId == request.auth.uid 
                      || resource.data.chefId == request.auth.uid
                      || isAdmin());
      
      // Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙ‚Ø· (Ù…Ù† Cloud Functions)
      allow create: if isSignedIn()
                    && request.resource.data.keys().hasAll(['invoiceNumber', 'orderId', 'total']);
      
      // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
      allow update: if isAdmin();
      
      // Ø§Ù„Ø­Ø°Ù: Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
      allow delete: if isAdmin();
    }

    // ============================================
    // Counters (Used for sequential invoice numbers)
    // ============================================
    match /counters/{counterId} {
      // Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„
      allow read: if isSignedIn();

      // Ø§Ù„ÙƒØªØ§Ø¨Ø©: ÙÙ‚Ø· Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
      allow create, update: if isSignedIn()
                            && counterId == 'invoices'
                            && request.resource.data.keys().hasOnly(['next'])
                            && request.resource.data.next is int
                            && request.resource.data.next >= 100
                            && (!exists(/databases/$(database)/documents/counters/invoices) 
                                || request.resource.data.next > resource.data.next);

      // Ø§Ù„Ø­Ø°Ù: Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·
      allow delete: if isAdmin();
    }
    
    // ============================================
    // Notifications Collection
    // ============================================
    match /notifications/{notificationId} {
      // Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ´ÙˆÙ Ø¥Ø´Ø¹Ø§Ø±Ø§ØªÙ‡ ÙÙ‚Ø·
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      
      // Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: Ø§Ù„Ù†Ø¸Ø§Ù… (Cloud Functions) Ø£Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù†
      allow create: if isAdmin() || !isSignedIn();
      
      // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ØµØ§Ø­Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± (Ù„ØªØ¹Ù„ÙŠÙ… ÙƒÙ…Ù‚Ø±ÙˆØ¡ ÙÙ‚Ø·)
      allow update: if isSignedIn() 
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.keys().hasOnly(['isRead', 'readAt'])
                    && request.resource.data.isRead == true;
      
      // Ø§Ù„Ø­Ø°Ù: ØµØ§Ø­Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø£Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù†
      allow delete: if (isSignedIn() && resource.data.userId == request.auth.uid) || isAdmin();
    }
    
    // ============================================
    // WhatsApp & Email Notifications (System Only)
    // ============================================
    match /whatsapp_notifications/{notificationId} {
      allow read: if isAdmin();
      allow create: if true; // Cloud Functions
      allow update, delete: if isAdmin();
    }
    
    match /email_notifications/{notificationId} {
      allow read: if isAdmin();
      allow create: if true; // Cloud Functions
      allow update, delete: if isAdmin();
    }
    
    // ============================================
    // Audit Logs (Admin Only)
    // ============================================
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // ============================================
    // Settings (Public Read, Admin Write)
    // ============================================
    match /settings/{settingId} {
      allow read: if true; // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© Ù…Ø«Ù„ Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„
      allow write: if isAdmin();
    }
    
    // ============================================
    // Banners (Public Read, Admin Write)
    // ============================================
    match /banners/{bannerId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // Default Deny All (Ù„Ù„Ø£Ù…Ø§Ù†)
    // ============================================
    // Ø£ÙŠ collection Ù…Ùˆ Ù…Ø­Ø¯Ø¯ Ø£Ø¹Ù„Ø§Ù‡ = Ù…Ù…Ù†ÙˆØ¹
  }
}
